<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Lager-Entnahme Terminal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen p-4 md:p-8">

<div class="menu-bar max-w-5xl mx-auto rounded-t-lg overflow-hidden">
    <div class="flex flex-col sm:flex-row">
        <div class="menu-item active px-6 py-3 text-white font-medium cursor-pointer text-center sm:text-left" id="terminalMenuItem">
            Lager-Entnahme Terminal
        </div>
        <div class="menu-item px-6 py-3 text-white font-medium cursor-pointer text-center sm:text-left" id="adminMenuItem">
            Administrator-Bereich
        </div>
        <div class="menu-item px-6 py-3 text-white font-medium cursor-pointer hidden text-center sm:text-left" id="historyMenuItem">
            Entnahme-Verlauf
        </div>
        <div class="menu-item px-6 py-3 text-white font-medium cursor-pointer hidden text-center sm:text-left" id="clarificationCasesMenuItem">
            Klärungsfälle
        </div>
    </div>
</div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="pinDialog">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Administrator-Anmeldung</h3>
        <p class="text-gray-600 mb-4">Bitte geben Sie den PIN-Code ein, um auf den Administrator-Bereich zuzugreifen.</p>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1" for="pinInput">PIN-Code</label>
            <input autocomplete="new-password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="pinInput" type="password"/>
            <p class="mt-1 text-sm text-red-600 hidden" id="pinError">Falscher PIN-Code. Bitte versuchen Sie es erneut.</p>
        </div>
        <div class="flex justify-end gap-3">
            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" id="cancelPin">Abbrechen</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="submitPin">Anmelden</button>
        </div>
    </div>
</div>

<div class="admin-panel max-w-5xl mx-auto bg-white shadow-md overflow-hidden rounded-b-lg">
    <div class="p-6">
        <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-800 mb-3">Material-Datenbank</h3>
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-end">
                <div class="flex-grow w-full">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="materialFile">CSV-Datei mit SAP-Nummern und Beschreibungen</label>
                    <input accept=".csv" autocomplete="off" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="materialFile" type="file"/>
                    <p class="mt-1 text-sm text-gray-500">Format: SAP-Nummer;Alternative SAP-Nummer;Beschreibung</p>
                </div>
                <button class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="uploadBtn" type="button">Hochladen</button>
            </div>
            <div class="mt-2 text-sm font-medium text-gray-600" id="databaseStatus">Status: Keine Materialdatenbank geladen</div>
        </div>
        <div class="mt-6 border-t border-gray-200 pt-6">
            <h3 class="text-lg font-medium text-gray-800 mb-3">Verwaltung</h3>
            <div class="flex flex-col sm:flex-row gap-3">
                <button class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="showNormalHistoryAdminBtn" type="button">Entnahme-Verlauf anzeigen</button>
                <button class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="showClarificationCasesAdminBtn" type="button">Klärungsfälle anzeigen</button>
            </div>
        </div>
        <button class="w-full md:w-auto px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 mt-6 hidden" id="backToAdminPanelBtn" type="button">Zurück zum Administrator-Bereich</button>
    </div>
</div>

<div class="terminal-container max-w-5xl mx-auto bg-white shadow-md overflow-hidden rounded-b-lg">
    <div class="terminal-header p-4 text-white flex justify-between items-center">
        <h1 class="text-xl md:text-2xl font-bold">Lager-Entnahme Terminal</h1>
        <div class="text-sm text-right">
            <span id="current-date"></span> <br class="md:hidden"/> <span id="current-time"></span>
        </div>
    </div>
    <div class="bg-white p-6">
        <form autocomplete="off" class="space-y-6" id="entnahmeForm">
            <div class="border-b border-gray-200 pb-4">
                <h2 class="text-lg font-medium text-gray-800 mb-3">Mitarbeiterinformationen</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="mitarbeiter">Name des Mitarbeiters</label>
                        <input autocomplete="off" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="mitarbeiter" name="mitarbeiter" required="" type="text"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="entnahmedatum">Datum der Entnahme</label>
                        <input autocomplete="off" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="entnahmedatum" name="entnahmedatum" required="" type="date"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="vorgesetzter">Name Vorgesetzter</label>
                        <input autocomplete="off" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="vorgesetzter" name="vorgesetzter" type="text"/>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="kostenstelle">Kostenstelle</label>
                        <input autocomplete="off" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="kostenstelle" name="kostenstelle" type="text"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="auftrag">Auftrag</label>
                        <input autocomplete="off" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="auftrag" name="auftrag" type="text"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="projektnr">Projekt-Nr.</label>
                        <input autocomplete="off" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" id="projektnr" name="projektnr" type="text"/>
                    </div>
                </div>
            </div>

            <div class="pb-4 mb-4">
                <h2 class="text-lg font-medium text-gray-800 mb-3">Material-Entnahme</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                        <tr class="text-left text-gray-600">
                            <th class="px-2 py-2 w-1/4">Materialnummer</th>
                            <th class="px-2 py-2 w-1/2">Beschreibung</th>
                            <th class="px-2 py-2 w-12">ME</th>
                            <th class="px-2 py-2 w-20">Menge</th>
                        </tr>
                        </thead>
                        <tbody id="materialTableBody">
                            <tr class="material-row">
                                <td class="px-2 py-1" data-label="Materialnummer">
                                    <div class="material-input-group">
                                        <input autocomplete="off" class="material-input w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" name="material_1" placeholder="Materialnummer" type="text"/>
                                        <button class="barcode-scan-btn" onclick="openBarcodeScanner(1)" type="button">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    </div>
                                    <input name="primary_material_1" type="hidden"/>
                                </td>
                                <td class="px-2 py-1" data-label="Beschreibung">
                                    <input autocomplete="off" class="description-field w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" name="description_1" placeholder="Beschreibung (optional)" type="text"/>
                                </td>
                                <td class="px-2 py-1" data-label="ME">
                                    <div class="me-dropdown">
                                        <input autocomplete="off" class="me-input w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" name="me_1" placeholder="ME" required="" type="text"/>
                                        <div class="me-dropdown-content">
                                            <div data-text="Stück" data-value="PC">Stück</div>
                                            <div data-text="Gramm" data-value="GR">Gramm</div>
                                            <div data-text="Liter" data-value="L">Liter</div>
                                            <div data-text="Meter" data-value="M">Meter</div>
                                            <div data-text="Kilogramm" data-value="KG">Kilogramm</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-2 py-1" data-label="Menge">
                                    <input autocomplete="off" class="menge-input w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" min="1" name="menge_1" placeholder="Menge" required="" step="any" type="number"/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-4">
                <button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" id="addRowBtn" type="button">
                    <i class="fas fa-plus mr-2"></i> Zeile hinzufügen
                </button>
                <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="submitBtn" type="submit">
                    <i class="fas fa-save mr-2"></i> Entnahme speichern
                </button>
            </div>
        </form>
    </div>
</div>

<div id="barcodeScannerDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Barcode scannen</h3>
        <p class="text-gray-600 mb-4">Richten Sie die Kamera auf den Barcode.</p>
        <div id="scanner-container">
            <video id="interactive" class="w-full h-auto rounded-md shadow"></video>
        </div>
        <div class="mt-4 flex justify-end">
            <button id="closeScannerBtn" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                Schließen
            </button>
        </div>
    </div>
</div>
<script src="script.js"></script>
</body>
</html>
